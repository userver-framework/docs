<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <!-- Yandex.Metrika counter -->
      <script type="text/javascript" >
        (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
        (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(94541714, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true
        });
      </script>
      <noscript><div><img src="https://mc.yandex.ru/watch/94541714" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
      <!-- /Yandex.Metrika counter -->
      <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=9"/>
      <meta name="generator" content="Doxygen 1.9.8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <meta property="og:image" content="../../logo_in_circle.png"/>
      <meta property="og:image:alt" content="userver logo"/>
      <link rel="icon" href="../../favicon.svg">
      <title>userver: gRPC</title>
      <!-- Roboto fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Roboto fonts -->
      <link href="../../tabs.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="../../jquery.js"></script>
      <!-- Highlight.js -->
      <link rel="stylesheet" href="../../highlightjs.css">
      <script src="../../highlight.min.js"></script>
      <!-- Highlight.js -->
      <!-- Roboto fonts -->
      <script type="text/javascript" src="../../dynsections.js"></script>
      <link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
      <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
      <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
      <link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
      <link rel="stylesheet" href="../../customdoxygen.css">
      <!-- Doxygen Awesome -->
      <script type="text/javascript" src="../../doxygen-awesome-darkmode-toggle.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-fragment-copy-button.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-paragraph-link.js"></script>
      <script type="text/javascript" src="../../doxygen-awesome-interactive-toc.js"></script>
      <script type="text/javascript" src="../../toc.js"></script>
      <script type="text/javascript">
        DoxygenAwesomeDarkModeToggle.init()
        DoxygenAwesomeFragmentCopyButton.init()
        DoxygenAwesomeParagraphLink.init()
        DoxygenAwesomeInteractiveToc.init()
      </script>
      <!-- Doxygen Awesome -->
    </head>
    <body>
      <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0" style="width: 100%;">
            <tbody>
              <tr style="height: 56px;">
                <td id="projectlogo"><a id='logo-anchor' href="../../index.html"><img alt="Logo" src="../../logo.svg"/></a></td>
                <td id="projectalign">
                  <div id="projectname">
                    <a class="titlelink" href="../../index.html">userver
                    </a>
                  </div>
                  <div id="projectbrief"><a class="titlelink" href="../../index.html">C++ Async Framework</a></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part --><!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d1/d06/md_en_2userver_2grpc.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">gRPC</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md238"></a> </p>
<h1><a class="anchor" id="autotoc_md239"></a>
Introduction</h1>
<p>üêô <b>userver</b> provides a gRPC driver as <code>userver-grpc</code> library. It uses <code>namespace <a class="el" href="../../df/d12/namespaceugrpc_1_1client.html" title="Client-side utilities.">ugrpc::client</a></code> and <code>namespace <a class="el" href="../../db/dfe/namespaceugrpc_1_1server.html" title="Server-side utilities.">ugrpc::server</a></code>.</p>
<p>The driver wraps <code>grpcpp</code> in the userver asynchronous interface.</p>
<p>See also:</p><ul>
<li><a class="el" href="../../d6/daa/md_en_2userver_2tutorial_2grpc__service.html">gRPC client and service</a></li>
<li><a href="https://grpc.io/docs/languages/cpp/">Official gRPC documentation</a></li>
<li><a href="https://grpc.github.io/grpc/cpp/index.html">grpcpp reference</a></li>
<li><a href="https://grpc.github.io/grpc/core/index.html">grpc-core reference</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md240"></a>
Capabilities</h1>
<ul>
<li>Creating asynchronous gRPC clients and services;</li>
<li>Forwarding gRPC Core logs to userver logs;</li>
<li>Caching and reusing connections;</li>
<li>Timeouts;</li>
<li>Collection of metrics on driver usage;</li>
<li>Cancellation support;</li>
<li>Automatic authentication using middlewares;</li>
<li><a class="el" href="../../d6/d64/md_en_2userver_2deadline__propagation.html">Deadline propagation</a> .</li>
</ul>
<h1><a class="anchor" id="autotoc_md241"></a>
Installation</h1>
<p>Generate and link a library from <code>.proto</code> schemas and link to it in your <code>CMakeLists.txt</code>:</p>
<div class="fragment"><div class="line">include(GrpcTargets)</div>
<div class="line">add_grpc_library(${PROJECT_NAME}-proto PROTOS samples/greeter.proto)</div>
<div class="line">target_link_libraries(${PROJECT_NAME} ${PROJECT_NAME}-proto)</div>
</div><!-- fragment --><p><code>add_grpc_library</code> will link <code>userver-grpc</code> transitively and will generate the usual <code>.pb.h + .pb.cc</code> files. For service definitions, it will additionally generate asynchronous interfaces <code>foo_client.usrv.pb.hpp</code> and <code>foo_service.usrv.pb.hpp</code>.</p>
<p>To create gRPC clients in your microservice, register the provided <a class="el" href="../../db/d02/classugrpc_1_1client_1_1ClientFactoryComponent.html" title="Provides a ClientFactory in the component system.">ugrpc::client::ClientFactoryComponent</a> and add the corresponding component section to the static config.</p>
<p>To create gRPC services in your microservice, register the provided <a class="el" href="../../d7/d9a/classugrpc_1_1server_1_1ServerComponent.html" title="Component that configures and manages the gRPC server.">ugrpc::server::ServerComponent</a> and add the corresponding component section to the static config.</p>
<h1><a class="anchor" id="autotoc_md242"></a>
gRPC clients</h1>
<h2><a class="anchor" id="autotoc_md243"></a>
Client creation</h2>
<p>In a component constructor, find <a class="el" href="../../db/d02/classugrpc_1_1client_1_1ClientFactoryComponent.html" title="Provides a ClientFactory in the component system.">ugrpc::client::ClientFactoryComponent</a> and store a reference to its <a class="el" href="../../d5/dac/classugrpc_1_1client_1_1ClientFactory.html" title="Creates generated gRPC clients. Has a minimal built-in channel cache: as long as a channel to the sam...">ugrpc::client::ClientFactory</a>. Using it, you can create gRPC clients of code-generated <code>YourServiceClient</code> types.</p>
<p>Client creation in an expensive operation! Either create them once at the server boot time or cache them.</p>
<h2><a class="anchor" id="autotoc_md244"></a>
Client usage</h2>
<p>Typical steps include:</p><ul>
<li>Filling a <code>std::unique_ptr&lt;grpc::ClientContext&gt;</code> with request settings<ul>
<li>gRPC documentation recommends using <code>set_deadline</code> for each RPC</li>
<li>Fill the authentication metadata as necessary</li>
</ul>
</li>
<li>Stream creation by calling a client method</li>
<li>Operations on the stream</li>
<li>Depending on the RPC kind, it is necessary to call <code>Finish</code> or <code>Read</code> until it returns <code>false</code> (otherwise the connection will close abruptly)</li>
</ul>
<p>Read the documentation on gRPC streams:</p><ul>
<li>Single request, single response <a class="el" href="../../d4/dd4/classugrpc_1_1client_1_1UnaryCall.html" title="Controls a single request -&gt; single response RPC.">ugrpc::client::UnaryCall</a></li>
<li>Single request, response stream <a class="el" href="../../d2/d96/classugrpc_1_1client_1_1InputStream.html" title="Controls a single request -&gt; response stream RPC.">ugrpc::client::InputStream</a></li>
<li>Request stream, single response <a class="el" href="../../d0/dec/classugrpc_1_1client_1_1OutputStream.html" title="Controls a request stream -&gt; single response RPC.">ugrpc::client::OutputStream</a></li>
<li>Request stream, response stream <a class="el" href="../../d1/dd7/classugrpc_1_1client_1_1BidirectionalStream.html" title="Controls a request stream -&gt; response stream RPC.">ugrpc::client::BidirectionalStream</a></li>
</ul>
<p>On errors, exceptions from <a class="el" href="../../db/dfb/grpc_2include_2userver_2ugrpc_2client_2exceptions_8hpp.html" title="Exceptions thrown by gRPC client streams.">userver/ugrpc/client/exceptions.hpp</a> are thrown. It is recommended to catch them outside the entire stream interaction. You can catch exceptions for <a href="https://grpc.github.io/grpc/core/md_doc_statuscodes.html">specific gRPC error codes</a> or all at once.</p>
<h1><a class="anchor" id="autotoc_md245"></a>
gRPC services</h1>
<h2><a class="anchor" id="autotoc_md246"></a>
Service creation</h2>
<p>A service implementation is a class derived from a code-generated <code>YourServiceBase</code> interface class. Each service method from the schema corresponds to a method of the interface class. If you don't override some of the methods, <code>UNIMPLEMENTED</code> error code will be reported for those.</p>
<p>To register your service:</p><ul>
<li>Create a component that derives from <a class="el" href="../../df/d19/classugrpc_1_1server_1_1ServiceComponentBase.html" title="Base class for all the gRPC service components.">ugrpc::server::ServiceComponentBase</a></li>
<li>Store your service implementation instance inside the component</li>
<li>Call <a class="el" href="../../df/d19/classugrpc_1_1server_1_1ServiceComponentBase.html#a395af87934a76f44ae7f419fc26d5b43">ugrpc::server::ServiceComponentBase::RegisterService</a> in the component's constructor</li>
<li>Don't forget to register your service component.</li>
</ul>
<h2><a class="anchor" id="autotoc_md247"></a>
Service method handling</h2>
<p>Each method receives:</p><ul>
<li>A stream controller object, used to respond to the RPC<ul>
<li>Also contains grpc::ClientContext from grpcpp library</li>
</ul>
</li>
<li>A request (for single-request RPCs only)</li>
</ul>
<p>When using a server stream, always call <code>Finish</code> or <code>FinishWithError</code>. Otherwise the client will receive <code>UNKNOWN</code> error, which signifies an internal server error.</p>
<p>Read the documentation on gRPC streams:</p><ul>
<li>Single request, single response <a class="el" href="../../d6/d9d/classugrpc_1_1server_1_1UnaryCall.html" title="Controls a single request -&gt; single response RPC.">ugrpc::server::UnaryCall</a></li>
<li>Request stream, single response <a class="el" href="../../dc/db6/classugrpc_1_1server_1_1InputStream.html" title="Controls a request stream -&gt; single response RPC.">ugrpc::server::InputStream</a></li>
<li>Single request, response stream <a class="el" href="../../da/d89/classugrpc_1_1server_1_1OutputStream.html" title="Controls a single request -&gt; response stream RPC.">ugrpc::server::OutputStream</a></li>
<li>Request stream, response stream <a class="el" href="../../d3/d6c/classugrpc_1_1server_1_1BidirectionalStream.html" title="Controls a request stream -&gt; response stream RPC.">ugrpc::server::BidirectionalStream</a></li>
</ul>
<p>On connection errors, exceptions from <a class="el" href="../../d0/dba/grpc_2include_2userver_2ugrpc_2server_2exceptions_8hpp.html" title="Errors thrown by gRPC server streams.">userver/ugrpc/server/exceptions.hpp</a> are thrown. It is recommended not to catch them, leading to RPC interruption. You can catch exceptions for <a href="https://grpc.github.io/grpc/core/md_doc_statuscodes.html">specific gRPC error codes</a> or all at once.</p>
<h2><a class="anchor" id="autotoc_md248"></a>
Middlewares</h2>
<p>The gRPC server can be extended by middlewares. Middleware is called on each incoming RPC request. Different middlewares handle the call subsequently. A middleware may decide to reject the call or call the next middleware in the stack. Middlewares may implement almost any enhancement to the gRPC server including authorization and authentication, ratelimiting, logging, tracing, audit, etc.</p>
<p>Middlewares to use are indicated in static config in section <code>middlewares</code> of <code><a class="el" href="../../df/d19/classugrpc_1_1server_1_1ServiceComponentBase.html" title="Base class for all the gRPC service components.">ugrpc::server::ServiceComponentBase</a></code> descendant component.</p>
<h1><a class="anchor" id="autotoc_md249"></a>
Metrics</h1>
<ul>
<li>Client metrics are put inside <code>grpc.client.by-destination {grpc_destination=FULL_SERVICE_NAME/METHOD_NAME}</code></li>
<li>Server metrics are put inside <code>grpc.server.by-destination {grpc_destination=FULL_SERVICE_NAME/METHOD_NAME}</code></li>
</ul>
<p>These are the metrics provided for each gRPC method:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Metric name   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">timings.1min   </td><td class="markdownTableBodyNone">time from RPC start to finish (<code><a class="el" href="../../df/d18/classutils_1_1statistics_1_1Percentile.html" title="Class stores M buckets of type Counter and allows easy calculation of percentiles.">utils::statistics::Percentile</a></code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">status.STATUS_CODE_NAME   </td><td class="markdownTableBodyNone">RPCs that finished with specified status codes    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">network-error   </td><td class="markdownTableBodyNone">RPCs that did not finish with a status due to a network error    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">abandoned-error   </td><td class="markdownTableBodyNone">RPCs that we forgot to <code>Finish</code> (always a bug in <code>ugrpc</code> usage)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">rps   </td><td class="markdownTableBodyNone">Requests per second: <code>sum(status) + network-error</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">eps   </td><td class="markdownTableBodyNone">Errors per second: <code>rps - status.OK</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">active   </td><td class="markdownTableBodyNone">The number of currently active RPCs (created and not finished)   </td></tr>
</table>
<hr  />
<p> <div class="bottom-nav">  ‚á¶ <a class="el" href="../../db/d8f/md_en_2userver_2profile__context__switches.html">Profiling context switches</a> | <a class="el" href="../../dd/de2/rabbitmq_driver.html">RabbitMQ (AMQP 0-9-1) - EXPERIMENTAL</a> ‚á®  </div>  </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Oct 4 2023 12:20:24 for userver by
    <a href="https://www.doxygen.org/index.html">Doxygen</a> 1.9.8</li>
  </ul>
</div>
<script type="text/javascript" src="../../codeHighlight.js"></script>
<script type="text/javascript" src="../../telegramLanguage.js"></script>
<script type="text/javascript" src="../../styledBtn.js"></script>
<script type="text/javascript" src="../../search.js"></script>
<script type="text/javascript" src="../../header.js"></script>
<script type="text/javascript" src="../../searchHighlight.js"></script>
<script>
  const addLinks = () =>  {
      const links = document.createElement('div')
      links.id = 'links';
      links.innerHTML = `
          <a href="https://github.com/userver-framework/" rel="noopener" target="_blank" class="titlelink">
              <img src="../../github_logo.svg" alt="Github" class="gh-logo"/> 
          </a>
          <a href="https://t.me/userver_en" rel="noopener" id='telegram_channel' target="_blank" class="titlelink">
              <img src="../../telegram_logo.svg" alt="Telegram"/>
          </a>
      `
      document.getElementById('main-navbar').appendChild(links);
  }
  $(function() {
    $(document).ready(function() {
      setTimeout(() => {
      init_all_results_button();
      init_header();
      addLinks();
      const isLanding = document.getElementById('landing_logo_id') !== null;
      if (isLanding) return;
      highlight_code();
      styleNavButtons(); // TODO: code style?
    }, 0);
    });
  });
</script>
</body>
</html>
